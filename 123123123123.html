<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ë³´ë“œê²Œì„ ëŒ€ì‹œë³´ë“œ (Sound + Missile)</title>
<style>
body {
  background: #eef3ff;
  font-family: 'Noto Sans KR', sans-serif;
  margin: 0; padding: 0;
  display: flex; justify-content: center; align-items: flex-start;
  height: 100vh; overflow-y: auto;
}

.board-wrapper {
  position: relative;
  width: 1000px;
  height: 800px;
  margin-left: 380px;
  margin-top: 20px;
}

.board {
  position: relative;
  width: 700px; height: 700px;
  margin: 0 auto;
  border-radius: 50%;
  background: #dbe8ff;
  box-shadow: 0 0 20px rgba(0,0,0,0.1);
}

#logo {
  position: fixed; top: 0; left: 10px;
  width: 360px; height: 360px;
  object-fit: contain; z-index: 1000;
}

#log-area {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  width: 400px; max-height: 250px;
  background: #fff; border: 3px solid #ccc; border-radius: 12px;
  text-align: center; padding: 10px;
  box-shadow: 0 0 10px rgba(0,0,0,0.2);
  overflow-y: auto;
  display: flex; flex-direction: column; z-index: 5;
}

#log-area h3 { margin: 0; padding-bottom: 6px; font-size: 18px; border-bottom: 1px solid #ddd; }
#log-list { font-size: 14px; margin-top: 8px; overflow-y: auto; word-break: break-word; flex-grow: 1; }

.log-item {
  padding: 6px 8px;
  border-bottom: 1px solid #ddd;
  cursor: pointer;
  transition: background-color 0.2s;
  user-select: none;
}
.log-item:hover { background-color: #f0f0f0; }

.team-card {
  position: absolute; width: 120px; height: 160px;
  background: #fdf6e3; border: 3px solid #c49e58;
  border-radius: 12px; text-align: center;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  transform-origin: center center;
  transition: transform 0.3s; cursor: pointer;
  user-select: none; display: flex;
  flex-direction: column; align-items: center; justify-content: flex-start;
  padding-top: 10px;
}

.team-card img { width: 80px; height: 80px; object-fit: contain; margin-bottom: 8px; }
.team-card h3 { margin: 0 0 6px 0; font-size: 18px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
.team-card p { margin: 0; font-size: 16px; color: #b33; font-weight: bold; }

.shake { animation: shake 0.4s; }
@keyframes shake { 0%{transform:translate(0,0);}25%{transform:translate(-5px,0);}50%{transform:translate(5px,0);}75%{transform:translate(-5px,0);}100%{transform:translate(0,0);} }

/* ë¯¸ì‚¬ì¼ */
.missile {
  position: absolute;
  width: 12px;
  height: 12px;
  background: linear-gradient(45deg, #ffb347, #ff5e5e);
  box-shadow: 0 0 8px rgba(255,94,94,0.7);
  border-radius: 50%;
  z-index: 1000;
  pointer-events: none;
}

/* í­ë°œ */
.explosion {
  position: absolute;
  width: 20px; height: 20px;
  background: yellow;
  border-radius: 50%;
  opacity: 0.9;
  z-index: 1001;
  pointer-events: none;
  animation: explode 0.5s forwards;
}

@keyframes explode {
  0% { transform: scale(0.6); opacity: 1; filter: blur(0px); }
  40% { transform: scale(2); opacity: 0.9; background: orange; filter: blur(1px); }
  100% { transform: scale(3.2); opacity: 0; background: red; filter: blur(2px); }
}
</style>
</head>
<body>
<div class="board-wrapper">
  <img id="logo" src="https://raw.githubusercontent.com/jinsw53/kingofleague/main/í‚¹ ì˜¤ë¸Œ ë¦¬ê·¸.png" alt="ë¡œê³ ">
  <div class="board" id="board">
    <div id="team-container"></div>
    <div id="log-area">
      <h3>ğŸ“œ ë¡œê·¸</h3>
      <div id="log-list"></div>
    </div>
  </div>
</div>

<script>
/* ---------------------------
   ë°ì´í„° URL / DOM ìº¡ì²˜
   --------------------------- */
const dataJsonUrl = 'https://jinsw53.github.io/kingofleague/data.json';
const logJsonUrl = 'https://jinsw53.github.io/kingofleague/logs.json';
const container = document.getElementById('team-container');
const logList = document.getElementById('log-list');
const board = document.getElementById('board');

/* ---------------------------
   ë ˆì´ì•„ì›ƒ ìƒìˆ˜
   --------------------------- */
const radius = 280;
const logWidth = 400;
const radiusAdjusted = radius + logWidth/2 - 150;
const centerX = 350;
const centerY = 350;

/* ---------------------------
   ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ (ì§€ì—° ìƒì„±)
   --------------------------- */
let audioCtx = null;
function ensureAudioContext(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
}

/* ë°œì‚¬ìŒ: ì§§ì€ ìƒìŠ¹ í†¤ + ì•½ê°„ì˜ ì¡ìŒ */
function playLaunchSound(){
  ensureAudioContext();
  const ctx = audioCtx;
  const now = ctx.currentTime;

  // í†¤ (sweep up)
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.type = 'sine';
  osc.frequency.setValueAtTime(400, now);
  osc.frequency.exponentialRampToValueAtTime(1200, now + 0.28);
  gain.gain.setValueAtTime(0.001, now);
  gain.gain.exponentialRampToValueAtTime(0.12, now + 0.05);
  gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.35);

  osc.connect(gain);
  gain.connect(ctx.destination);
  osc.start(now);
  osc.stop(now + 0.36);

  // ì§§ì€ ê³ ì£¼íŒŒ ì¡ìŒ(íœ˜ìµ)
  const bufferSize = 2 * ctx.sampleRate;
  const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
  const output = noiseBuffer.getChannelData(0);
  for (let i = 0; i < bufferSize; i++) output[i] = (Math.random() * 2 - 1) * Math.exp(-i / (bufferSize * 0.6));
  const noise = ctx.createBufferSource();
  noise.buffer = noiseBuffer;
  const noiseGain = ctx.createGain();
  noiseGain.gain.setValueAtTime(0.08, now);
  noiseGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.35);
  noise.connect(noiseGain);
  noiseGain.connect(ctx.destination);
  noise.start(now);
  noise.stop(now + 0.35);
}

/* í­ë°œìŒ: ì €ì—­ í€ì¹˜ + ë…¸ì´ì¦ˆ ë²„ìŠ¤íŠ¸ */
function playExplosionSound(){
  ensureAudioContext();
  const ctx = audioCtx;
  const now = ctx.currentTime;

  // ì €ì—­ í€ì¹˜(ì§§ì€ ì‚¬ì¸)
  const osc = ctx.createOscillator();
  osc.type = 'sine';
  osc.frequency.setValueAtTime(120, now);
  osc.frequency.exponentialRampToValueAtTime(60, now + 0.18);
  const gain = ctx.createGain();
  gain.gain.setValueAtTime(0.001, now);
  gain.gain.exponentialRampToValueAtTime(0.6, now + 0.02);
  gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.6);
  osc.connect(gain);
  gain.connect(ctx.destination);
  osc.start(now);
  osc.stop(now + 0.6);

  // í­ë°œ ë…¸ì´ì¦ˆ ë²„ìŠ¤íŠ¸
  const bufferSize = ctx.sampleRate * 0.6;
  const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
  const output = noiseBuffer.getChannelData(0);
  for (let i = 0; i < bufferSize; i++){
    // ì´ˆê¸° ê°•í•œ ì¡ìŒ í›„ ì„œì„œíˆ ì¤„ì–´ë“¤ê²Œ
    output[i] = (Math.random() * 2 - 1) * (1 - i / bufferSize);
  }
  const noise = ctx.createBufferSource();
  noise.buffer = noiseBuffer;
  const noiseFilter = ctx.createBiquadFilter();
  noiseFilter.type = 'bandpass';
  noiseFilter.frequency.value = 1000;
  noiseFilter.Q.value = 0.6;

  const noiseGain = ctx.createGain();
  noiseGain.gain.setValueAtTime(0.8, now);
  noiseGain.gain.exponentialRampToValueAtTime(0.001, now + 0.5);

  noise.connect(noiseFilter);
  noiseFilter.connect(noiseGain);
  noiseGain.connect(ctx.destination);
  noise.start(now);
  noise.stop(now + 0.5);
}

/* ---------------------------
   ìœ í‹¸: í°íŠ¸ í¬ê¸° ì¡°ì •
   --------------------------- */
function adjustFontSize(element, maxWidth){
  let fontSize = parseInt(window.getComputedStyle(element).fontSize);
  while(element.scrollWidth > maxWidth && fontSize > 8){
    fontSize--; element.style.fontSize = fontSize+'px';
  }
}

/* ---------------------------
   ë¯¸ì‚¬ì¼ ë°œì‚¬ + í­ë°œ (ì‹œê° + ìŒí–¥)
   --------------------------- */
function launchMissile(fromCard, toCard){
  // ì˜¤ë””ì˜¤ëŠ” ì‚¬ìš©ìì˜ í´ë¦­(ì œìŠ¤ì²˜) ì´í›„ ì»¨í…ìŠ¤íŠ¸ ìƒì„±
  playLaunchSound();

  const missile = document.createElement('div');
  missile.className = 'missile';
  board.appendChild(missile);

  const fromRect = fromCard.getBoundingClientRect();
  const toRect = toCard.getBoundingClientRect();
  const boardRect = board.getBoundingClientRect();

  const startX = fromRect.left + fromRect.width/2 - boardRect.left;
  const startY = fromRect.top + fromRect.height/2 - boardRect.top;
  const endX = toRect.left + toRect.width/2 - boardRect.left;
  const endY = toRect.top + toRect.height/2 - boardRect.top;

  // ì•½ê°„ì˜ ê³¡ì„  íš¨ê³¼ë¥¼ ì£¼ê¸° ìœ„í•´ ì¤‘ê°„ ì˜¤í”„ì…‹ (ë‹¨ì¼ êµ½í˜)
  const midX = (startX + endX) / 2;
  const midY = (startY + endY) / 2 - Math.max(30, Math.hypot(endX-startX, endY-startY) * 0.12);

  const duration = 620; // ms (ê±°ë¦¬ ìƒê´€ì—†ì´ ê³ ì •ìœ¼ë¡œ ìì—°ìŠ¤ëŸ¬ì›€)
  const startTime = performance.now();

  function animate(now){
    let t = (now - startTime) / duration;
    if (t > 1) t = 1;

    // ë² ì§€ì–´(ì¿¼ë“œ) ë³´ê°„: B(t) = (1 - t)^2 * P0 + 2*(1-t)*t*P1 + t^2 * P2
    const inv = 1 - t;
    const x = inv*inv*startX + 2*inv*t*midX + t*t*endX;
    const y = inv*inv*startY + 2*inv*t*midY + t*t*endY;

    missile.style.left = (x - 6) + 'px';
    missile.style.top = (y - 6) + 'px';

    // ë¯¸ì‚¬ì¼ íšŒì „(ì§„í–‰ ë°©í–¥)
    if(t < 1){
      requestAnimationFrame(animate);
    } else {
      missile.remove();

      // í­ë°œ ì‹œê° íš¨ê³¼
      const explosion = document.createElement('div');
      explosion.className = 'explosion';
      explosion.style.left = (endX - 16) + 'px';
      explosion.style.top = (endY - 16) + 'px';
      board.appendChild(explosion);

      // í­ë°œ ì†Œë¦¬
      playExplosionSound();

      setTimeout(()=> explosion.remove(), 520);
    }
  }
  requestAnimationFrame(animate);
}

/* ---------------------------
   ë°ì´í„° ë¡œë“œ ë° UI êµ¬ì„±
   --------------------------- */
async function fetchData(){
  try {
    const response = await fetch(dataJsonUrl);
    const data = await response.json();
    container.innerHTML = '';
    const visibleData = data.filter(item => item.íŒ€ëª… && item.íŒ€ëª….trim() !== "");
    visibleData.forEach((item,i)=>{
      const name = item.íŒ€ëª…;
      const life = item.í•˜íŠ¸ || 3;
      const game = item['íšŒë³µì— í•„ìš”í•œ ê²Œì„'] || '';
      const logo = item.ë¡œê³  || 'https://via.placeholder.com/80';
      const angle = (360/visibleData.length)*i;
      const rad = angle*Math.PI/180;
      const x = centerX + radiusAdjusted*Math.cos(rad) - 60;
      const y = centerY + radiusAdjusted*Math.sin(rad) - 80;

      const card = document.createElement('div');
      card.className='team-card';
      card.style.left = `${x}px`;
      card.style.top = `${y}px`;
      card.setAttribute('data-team', name);
      card.setAttribute('data-game', game);
      card.innerHTML=`
        <img src="${logo}" alt="${name} ë¡œê³ ">
        <h3>${name}</h3>
        <p>${'â¤ï¸'.repeat(life)}</p>
      `;
      container.appendChild(card);
      adjustFontSize(card.querySelector('h3'),100);
    });
  } catch(e){ console.error('Error fetching data:', e); }
}

async function fetchLogs(){
  try{
    const response = await fetch(logJsonUrl);
    const logs = await response.json();
    logList.innerHTML = '';

    logs.forEach(item=>{
      const attackerName = item['ê³µê²© íŒ€'];
      const gameName = item['ê²Œì„'];
      const logText = `${attackerName} íŒ€ì´ (${gameName})${item['ê³µê²© / íšŒë³µ íŒë‹¨']}`;
      const logDiv = document.createElement('div');
      logDiv.className='log-item';
      logDiv.innerText=logText;

      logDiv.onclick = () => {
        // ì²« ì‚¬ìš©ì ì œìŠ¤ì²˜ì—ì„œ ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ë¥¼ í™œì„±í™”
        ensureAudioContext();

        const attackerCard = document.querySelector(`.team-card[data-team="${attackerName}"]`);
        if (!attackerCard) {
          console.warn(`ê³µê²© íŒ€ ì¹´ë“œ ë¯¸ë°œê²¬: ${attackerName}`);
          return;
        }

        console.log('--- ë¡œê·¸ í´ë¦­ ---');
        console.log('ê³µê²© íŒ€:', attackerName);
        console.log('ê²Œì„:', gameName);

        const currentCards = document.querySelectorAll('.team-card');
        console.log('ì „ì²´ ì¹´ë“œ ë°ì´í„°:');
        Array.from(currentCards).forEach(c => {
          console.log(`- ${c.dataset.team}: "${c.dataset.game}"`);
        });

        attackerCard.classList.add('shake');
        setTimeout(() => attackerCard.classList.remove('shake'), 500);

        // íƒ€ê¹ƒ ì„ íƒ (ê²Œì„ëª… í¬í•¨ ê²€ìƒ‰, ì†Œë¬¸ì/ê³µë°± ì²˜ë¦¬)
        const targets = Array.from(currentCards).filter(c => {
          const cardGame = (c.dataset.game || '').trim().toLowerCase();
          const gameToMatch = (gameName || '').trim().toLowerCase();
          return cardGame.includes(gameToMatch) && c.dataset.team !== attackerName;
        });

        if(targets.length === 0) console.warn('íƒ€ê¹ƒ ì—†ìŒ!');
        console.log('ì„ íƒëœ íƒ€ê¹ƒ:');
        targets.forEach(t => console.log(`- ${t.dataset.team}`));

        // ë°œì‚¬: ì—¬ëŸ¬ íƒ€ê¹ƒì´ë©´ ì§§ì€ ê°„ê²©(ìˆœì°¨)ìœ¼ë¡œ ë°œì‚¬í•˜ë©´ ë³´ê¸° ì¢‹ìŒ
        targets.forEach((t, idx) => {
          setTimeout(() => {
            launchMissile(attackerCard, t);
            t.classList.add('shake');
            setTimeout(() => t.classList.remove('shake'), 500);
          }, idx * 180); // 180ms ê°„ê²©ìœ¼ë¡œ ì—°ì† ë°œì‚¬
        });
      };

      logList.prepend(logDiv);
    });
  }catch(e){ console.error('Error fetching logs:',e);}
}

window.addEventListener('load', async ()=>{
  await fetchData();
  await fetchLogs();
});
</script>
</body>
</html>
